{% extends layout_path %}
{% load static %}

{% block title %}Paramètres du profil{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-lg-9">
      <div class="nav-align-top mb-6">
        <ul class="nav nav-pills flex-column flex-md-row gap-2 gap-md-0">
          <li class="nav-item">
            <a class="nav-link active" href="{% url 'pages-account-settings-account' %}">
              <i class="icon-base bx bx-user icon-sm me-1_5"></i>
              Profil
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'pages-account-settings-notifications' %}">
              <i class="icon-base bx bx-bell icon-sm me-1_5"></i>
              Notifications
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'pages-account-settings-connections' %}">
              <i class="icon-base bx bx-link-alt icon-sm me-1_5"></i>
              Connexions
            </a>
          </li>
        </ul>
      </div>

      <form method="post" enctype="multipart/form-data" class="card">
        {% csrf_token %}
        <input type="hidden" name="profile_submit" value="1">
        <div class="card-body border-bottom">
          <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-4">
            <img
              src="{{ request.user.profile_image_url }}"
              alt="Avatar"
              class="d-block rounded-circle object-fit-cover"
              style="width: 96px; height: 96px;"
            />
            <div class="flex-grow-1">
              <h5 class="mb-1">{{ request.user.display_name }}</h5>
              <p class="text-body-secondary mb-3">{{ request.user.role_label }}</p>
              <div class="d-flex align-items-center flex-wrap gap-3">
                <label for="{{ profile_form.profile_image.id_for_label }}" class="btn btn-primary mb-0">
                  Changer la photo
                </label>
                {{ profile_form.profile_image }}
                <div class="form-check">
                  {{ profile_form.delete_image }}
                  <label class="form-check-label" for="{{ profile_form.delete_image.id_for_label }}">
                    {{ profile_form.delete_image.label }}
                  </label>
                </div>
              </div>
              {% if profile_form.profile_image.errors %}
                <div class="text-danger small mt-2">
                  {{ profile_form.profile_image.errors|join:", " }}
                </div>
              {% endif %}
              {% if profile_form.delete_image.errors %}
                <div class="text-danger small mt-2">
                  {{ profile_form.delete_image.errors|join:", " }}
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="card-body">
          {% if profile_form.non_field_errors %}
            <div class="alert alert-danger">
              {{ profile_form.non_field_errors|join:", " }}
            </div>
          {% endif %}
          <div class="row g-6">
            <div class="col-md-6">
              <label class="form-label" for="{{ profile_form.username.id_for_label }}">{{ profile_form.username.label }}</label>
              {{ profile_form.username }}
              {% if profile_form.username.errors %}
                <div class="text-danger small mt-1">
                  {{ profile_form.username.errors|join:", " }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label" for="{{ profile_form.email.id_for_label }}">{{ profile_form.email.label }}</label>
              {{ profile_form.email }}
              {% if profile_form.email.errors %}
                <div class="text-danger small mt-1">
                  {{ profile_form.email.errors|join:", " }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label">Rôle</label>
              <input type="text" class="form-control" value="{{ request.user.role_label }}" disabled>
              <div class="form-text">Contactez un administrateur pour modifier votre rôle.</div>
            </div>
          </div>

          <div class="mt-6 d-flex flex-wrap gap-3">
            <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
            <a href="{% url 'index' %}" class="btn btn-outline-secondary">Annuler</a>
          </div>
        </div>
      </form>

      <form method="post" class="card mt-6">
        {% csrf_token %}
        <input type="hidden" name="password_submit" value="1">
        <div class="card-header">
          <h5 class="mb-0">Modifier le mot de passe</h5>
        </div>
        <div class="card-body">
          {% if password_form.non_field_errors %}
            <div class="alert alert-danger">
              {{ password_form.non_field_errors|join:", " }}
            </div>
          {% endif %}
          <div class="row g-6">
            <div class="col-md-6">
              <label class="form-label" for="{{ password_form.current_password.id_for_label }}">{{ password_form.current_password.label }}</label>
              {{ password_form.current_password }}
              {% if password_form.current_password.errors %}
                <div class="text-danger small mt-1">
                  {{ password_form.current_password.errors|join:", " }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label" for="{{ password_form.new_password1.id_for_label }}">{{ password_form.new_password1.label }}</label>
              {{ password_form.new_password1 }}
              {% if password_form.new_password1.errors %}
                <div class="text-danger small mt-1">
                  {{ password_form.new_password1.errors|join:", " }}
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label" for="{{ password_form.new_password2.id_for_label }}">{{ password_form.new_password2.label }}</label>
              {{ password_form.new_password2 }}
              {% if password_form.new_password2.errors %}
                <div class="text-danger small mt-1">
                  {{ password_form.new_password2.errors|join:", " }}
                </div>
              {% endif %}
            </div>
          </div>
          <div class="mt-6">
            <button type="submit" class="btn btn-primary">Mettre à jour le mot de passe</button>
          </div>
        </div>
      </form>

      <div class="card mt-6">
        <div class="card-header">
          <h5 class="mb-0">Supprimer le compte</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-warning">
            <h6 class="alert-heading mb-1">Action irréversible</h6>
            <p class="mb-0">Contactez un administrateur si vous souhaitez désactiver votre compte.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
