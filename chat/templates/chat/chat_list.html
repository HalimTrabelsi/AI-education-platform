{% extends layout_path %}

{% block title %}Messagerie{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Conversations</h5>
          <span class="badge bg-label-primary">{{ rooms|length }}</span>
        </div>
        <div class="list-group list-group-flush">
          {% for entry in rooms %}
            <a href="{% url 'chat:room' entry.room.room_key %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              <span>
                {% if entry.partner %}
                  {{ entry.partner.username }} <small class="text-body-secondary">({{ entry.partner.role }})</small>
                {% else %}
                  Utilisateur inconnu
                {% endif %}
              </span>
              <i class="bx bx-chevron-right"></i>
            </a>
          {% empty %}
            <div class="list-group-item text-body-secondary">Aucune conversation pour le moment.</div>
          {% endfor %}
        </div>
      </div>

      {% if potential_targets %}
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Nouvelle discussion</h5>
          </div>
          <div class="card-body">
            <p class="text-body-secondary">
              Sélectionnez un
              {% if current_user.role == 'student' %}
                enseignant
              {% else %}
                étudiant
              {% endif %}
              pour démarrer une conversation.
            </p>
            <form method="post" action="{% url 'chat:start' 'placeholder' %}" id="start-chat-form">
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label" for="target-user">Choisir un contact</label>
                <select class="form-select" id="target-user">
                  <option value="">-- Sélectionnez --</option>
                  {% for user in potential_targets %}
                    <option value="{{ user.id }}">{{ user.username }} ({{ user.role }})</option>
                  {% endfor %}
                </select>
              </div>
              <button type="submit" class="btn btn-primary w-100" id="start-chat-submit" disabled>Démarrer</button>
            </form>
          </div>
        </div>
      {% else %}
        <div class="alert alert-info">La messagerie est réservée aux étudiants et enseignants.</div>
      {% endif %}
    </div>

    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-body d-flex flex-column justify-content-center text-center text-body-secondary">
          <i class="bx bx-message-dots icon-xxl mb-3"></i>
          <h4>Choisissez une conversation</h4>
          <p>Pour commencer, sélectionnez un contact existant ou créez une nouvelle discussion.</p>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block page_js %}
  {{ block.super }}
  <script>
    (function() {
      const select = document.getElementById('target-user');
      const form = document.getElementById('start-chat-form');
      const submit = document.getElementById('start-chat-submit');

      if (!select || !form || !submit) {
        return;
      }

      select.addEventListener('change', function() {
        const userId = select.value;
        submit.disabled = !userId;
        if (userId) {
          form.action = '{% url "chat:start" "USER_ID" %}'.replace('USER_ID', userId);
        }
      });
    })();
  </script>
{% endblock %}
