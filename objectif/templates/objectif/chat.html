{% extends "layout/layout_vertical.html" %}
{% load static %}

{% block title %}Assistant IA{% endblock %}

{% block content %}
<div class="row gy-4">
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="mb-1">Vos objectifs</h5>
        <p class="mb-0 text-body-secondary">Sélectionnez un objectif pour contextualiser les réponses d’EduBot.</p>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush" id="objectivesList">
          {% for objectif in objectifs %}
            <button type="button"
                    class="list-group-item list-group-item-action d-flex flex-column align-items-start gap-1 text-start"
                    data-objective="{{ objectif.id }}"
                    data-title="{{ objectif.titre }}"
                    data-status="{{ objectif.etat }}"
                    data-priority="{{ objectif.priorite }}"
                    data-progress="{{ objectif.progression|default:0 }}">
              <span class="fw-semibold">{{ objectif.titre }}</span>
              <small class="text-body-secondary">
                Priorité : {{ objectif.priorite|default:"—" }} · État : {{ objectif.etat|default:"—" }}
              </small>
              {% if objectif.progression %}
                <div class="progress w-100" style="height: 4px;">
                  <div class="progress-bar bg-primary" role="progressbar"
                       style="width: {{ objectif.progression }}%;" aria-valuenow="{{ objectif.progression }}"
                       aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              {% endif %}
            </button>
          {% empty %}
            <div class="p-4 text-center text-body-secondary">
              <i class="bx bx-target fs-1 d-block mb-2"></i>
              Aucun objectif pour le moment.
            </div>
          {% endfor %}
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between">
        <a href="{% url 'objectifs:list' %}" class="btn btn-outline-secondary btn-sm">
          <i class="bx bx-list-ul me-1"></i> Liste
        </a>
        <a href="{% url 'objectifs:create' %}" class="btn btn-primary btn-sm">
          <i class="bx bx-plus me-1"></i> Nouvel objectif
        </a>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-1">EduBot</h5>
          <p class="mb-0 text-body-secondary">Assistant IA pour vous guider dans vos objectifs académiques.</p>
        </div>
        <div id="selectedObjectiveChip" class="badge bg-label-primary d-none text-wrap"></div>
      </div>
      <div class="card-body d-flex flex-column">
        <div class="border rounded p-3 mb-3 flex-grow-1 overflow-auto" id="chatMessages" style="max-height: 420px;">
          <div class="text-body-secondary text-center">
            <p class="mb-0">Commencez une conversation en sélectionnant un objectif ou en envoyant un message.</p>
          </div>
        </div>
        <form id="chatForm" class="pt-2">
          {% csrf_token %}
          <input type="hidden" name="objective_id" id="selectedObjectiveInput">
          <div class="input-group">
            <input type="text" class="form-control" id="messageInput" name="message"
                   placeholder="Posez votre question à EduBot..." autocomplete="off">
            <button class="btn btn-primary" type="submit" id="sendBtn">
              <i class="bx bx-send"></i>
            </button>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <button class="btn btn-outline-secondary btn-sm suggestion-btn" type="button"
                    data-message="Comment améliorer ma gestion du temps ?">
              Gestion du temps
            </button>
            <button class="btn btn-outline-secondary btn-sm suggestion-btn" type="button"
                    data-message="Quelle priorité donner à mes objectifs actuels ?">
              Priorités
            </button>
            <button class="btn btn-outline-secondary btn-sm suggestion-btn" type="button"
                    data-message="Comment rester motivé pour atteindre mes objectifs ?">
              Motivation
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
  {{ block.super }}
  <script>
    (function () {
      const chatForm = document.getElementById("chatForm");
      const messageInput = document.getElementById("messageInput");
      const messagesWrapper = document.getElementById("chatMessages");
      const sendBtn = document.getElementById("sendBtn");
      const objectiveChip = document.getElementById("selectedObjectiveChip");
      const objectiveInput = document.getElementById("selectedObjectiveInput");
      const suggestionButtons = document.querySelectorAll(".suggestion-btn");
      let activeObjectiveButton = null;

      function scrollToBottom() {
        messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
      }

      function addMessage(content, variant) {
        const wrapper = document.createElement("div");
        wrapper.className = "d-flex mb-3";

        const bubble = document.createElement("div");
        bubble.className = "px-3 py-2 rounded-3";
        bubble.innerHTML = content;

        if (variant === "user") {
          wrapper.classList.add("justify-content-end");
          bubble.classList.add("bg-primary", "text-white", "ms-auto");
        } else {
          wrapper.classList.add("justify-content-start");
          bubble.classList.add("bg-label-secondary", "text-body");
        }

        wrapper.appendChild(bubble);
        messagesWrapper.appendChild(wrapper);
        scrollToBottom();
      }

      function setActiveObjective(button) {
        if (activeObjectiveButton) {
          activeObjectiveButton.classList.remove("active");
        }

        activeObjectiveButton = button;

        if (!button) {
          objectiveInput.value = "";
          objectiveChip.classList.add("d-none");
          return;
        }

        button.classList.add("active");
        const title = button.dataset.title || "Objectif sélectionné";
        const status = button.dataset.status || "État inconnu";

        objectiveInput.value = button.dataset.objective || "";
        objectiveChip.textContent = `${title} · ${status}`;
        objectiveChip.classList.remove("d-none");
      }

      document.querySelectorAll("#objectivesList button").forEach((btn) => {
        btn.addEventListener("click", () => setActiveObjective(btn));
      });

      suggestionButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const message = btn.dataset.message || "";
          if (message) {
            sendMessage(message);
          }
        });
      });

      function sendMessage(message) {
        if (!message.trim()) {
          return;
        }

        addMessage(message, "user");
        messageInput.value = "";
        messageInput.focus();
        sendBtn.disabled = true;

        const formData = new FormData(chatForm);
        formData.set("message", message);

        fetch("{% url 'objectifs:assistant_api' %}", {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest"
          },
          body: formData
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.reply) {
              addMessage(data.reply, "bot");
            } else if (data.error) {
              addMessage(data.error, "bot");
            }
          })
          .catch(() => {
            addMessage("Une erreur est survenue. Merci de réessayer.", "bot");
          })
          .finally(() => {
            sendBtn.disabled = false;
          });
      }

      chatForm.addEventListener("submit", (event) => {
        event.preventDefault();
        sendMessage(messageInput.value);
      });

      messageInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage(messageInput.value);
        }
      });
    })();
  </script>
{% endblock %}
