{% extends "layout/layout_vertical.html" %}

{% block content %}
<div class="container mt-4">
    <h2>{% if form.instance.id %}Modifier{% else %}Créer{% endif %} un objectif</h2>

    <!-- Affichage des erreurs générales -->
    {% if form.non_field_errors %}
    <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
            {{ error }}
        {% endfor %}
    </div>
    {% endif %}

    <form method="POST" novalidate id="objectif-form">
        {% csrf_token %}

        <!-- Titre -->
        <div class="mb-3">
            <label for="id_titre" class="form-label">Titre : <span class="text-danger">*</span></label>
            <input type="text" class="form-control {% if form.titre.errors %}is-invalid{% endif %}"
                   id="id_titre" name="titre"
                   value="{{ form.titre.value|default_if_none:'' }}"
                   required maxlength="100"
                   placeholder="Ex: Préparation examen final">
            <div class="form-text">Maximum 100 caractères</div>
            {% if form.titre.errors %}
            <div class="invalid-feedback">
                {% for error in form.titre.errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Description -->
        <div class="mb-3">
            <label for="id_description" class="form-label">Description :</label>
            <textarea class="form-control {% if form.description.errors %}is-invalid{% endif %}"
                      id="id_description" name="description"
                      rows="4" maxlength="500"
                      placeholder="Décrivez votre objectif en détail...">{{ form.description.value|default_if_none:'' }}</textarea>
            <div class="form-text">Maximum 500 caractères</div>
            <div class="text-muted small mt-1">
                Caractères restants: <span id="description-counter">500</span>
            </div>
            {% if form.description.errors %}
            <div class="invalid-feedback">
                {% for error in form.description.errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Filière -->
        <div class="mb-3">
            <label for="id_filiere" class="form-label">Filière : <span class="text-danger">*</span></label>
            <input type="text" class="form-control {% if form.filiere.errors %}is-invalid{% endif %}"
                   id="id_filiere" name="filiere"
                   value="{{ form.filiere.value|default_if_none:'' }}"
                   required maxlength="50"
                   placeholder="Ex: Informatique, Mathématiques">
            <div class="form-text">Maximum 50 caractères</div>
            {% if form.filiere.errors %}
            <div class="invalid-feedback">
                {% for error in form.filiere.errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Niveau -->
        <div class="mb-3">
            <label for="id_niveau" class="form-label">Niveau : <span class="text-danger">*</span></label>
            <select class="form-select {% if form.niveau.errors %}is-invalid{% endif %}"
                    id="id_niveau" name="niveau" required>
                <option value="">Sélectionnez un niveau</option>
                <option value="Licence 1" {% if form.niveau.value == 'Licence 1' %}selected{% endif %}>Licence 1</option>
                <option value="Licence 2" {% if form.niveau.value == 'Licence 2' %}selected{% endif %}>Licence 2</option>
                <option value="Licence 3" {% if form.niveau.value == 'Licence 3' %}selected{% endif %}>Licence 3</option>
                <option value="Master 1" {% if form.niveau.value == 'Master 1' %}selected{% endif %}>Master 1</option>
                <option value="Master 2" {% if form.niveau.value == 'Master 2' %}selected{% endif %}>Master 2</option>
                <option value="Doctorat" {% if form.niveau.value == 'Doctorat' %}selected{% endif %}>Doctorat</option>
            </select>
            {% if form.niveau.errors %}
            <div class="invalid-feedback">
                {% for error in form.niveau.errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Priorité -->
<!-- Priorité -->
<div class="mb-3">
    <label for="id_priorite" class="form-label">Priorité : <span class="text-danger">*</span></label>
    <select class="form-select {% if form.priorite.errors %}is-invalid{% endif %}"
            id="id_priorite" name="priorite" required>
        <option value="">Sélectionnez une priorité</option>
        <option value="haute" {% if form.priorite.value == 'haute' %}selected{% endif %}>Haute</option>
        <option value="moyenne" {% if form.priorite.value == 'moyenne' %}selected{% endif %}>Moyenne</option>
        <option value="basse" {% if form.priorite.value == 'basse' %}selected{% endif %}>Basse</option>
    </select>
    {% if form.priorite.errors %}
    <div class="invalid-feedback">
        {% for error in form.priorite.errors %}
            {{ error }}
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- État -->
<div class="mb-3">
    <label for="id_etat" class="form-label">État : <span class="text-danger">*</span></label>
    <select class="form-select {% if form.etat.errors %}is-invalid{% endif %}"
            id="id_etat" name="etat" required>
        <option value="">Sélectionnez un état</option>
        <option value="non commencé" {% if form.etat.value == 'non commencé' %}selected{% endif %}>Non commencé</option>
        <option value="en cours" {% if form.etat.value == 'en cours' %}selected{% endif %}>En cours</option>
        <option value="terminé" {% if form.etat.value == 'terminé' %}selected{% endif %}>Terminé</option>
    </select>
    {% if form.etat.errors %}
    <div class="invalid-feedback">
        {% for error in form.etat.errors %}
            {{ error }}
        {% endfor %}
    </div>
    {% endif %}
</div>

        <!-- Date début -->
        <div class="mb-3">
            <label for="id_date_debut" class="form-label">Date début :</label>
            <input type="datetime-local" class="form-control {% if form.date_debut.errors %}is-invalid{% endif %}"
                   id="id_date_debut" name="date_debut"
                   value="{{ form.date_debut.value|default_if_none:'' }}">
            {% if form.date_debut.errors %}
            <div class="invalid-feedback">
                {% for error in form.date_debut.errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Date échéance -->
        <div class="mb-3">
            <label for="id_date_echeance" class="form-label">Date échéance :</label>
            <input type="datetime-local" class="form-control {% if form.date_echeance.errors %}is-invalid{% endif %}"
                   id="id_date_echeance" name="date_echeance"
                   value="{{ form.date_echeance.value|default_if_none:'' }}">
            {% if form.date_echeance.errors %}
            <div class="invalid-feedback">
                {% for error in form.date_echeance.errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Validation des dates -->
        <div id="date-validation" class="alert alert-warning d-none">
            <i class="fas fa-exclamation-triangle"></i>
            La date d'échéance doit être postérieure à la date de début.
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" id="submit-btn">
                <i class="fas fa-save me-1"></i>Enregistrer
            </button>
            <a href="{% url 'objectifs:list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Retour à la liste
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('objectif-form');
    const descriptionField = document.getElementById('id_description');
    const descriptionCounter = document.getElementById('description-counter');
    const dateDebut = document.getElementById('id_date_debut');
    const dateEcheance = document.getElementById('id_date_echeance');
    const dateValidation = document.getElementById('date-validation');
    const submitBtn = document.getElementById('submit-btn');

    // Compteur de caractères pour la description
    function updateDescriptionCounter() {
        const remaining = 500 - descriptionField.value.length;
        descriptionCounter.textContent = remaining;

        if (remaining < 0) {
            descriptionCounter.classList.add('text-danger');
        } else {
            descriptionCounter.classList.remove('text-danger');
        }
    }

    descriptionField.addEventListener('input', updateDescriptionCounter);
    updateDescriptionCounter(); // Initialiser le compteur

    // Validation des dates
    function validateDates() {
        if (dateDebut.value && dateEcheance.value) {
            const debut = new Date(dateDebut.value);
            const echeance = new Date(dateEcheance.value);

            if (echeance <= debut) {
                dateValidation.classList.remove('d-none');
                submitBtn.disabled = true;
                return false;
            }
        }

        dateValidation.classList.add('d-none');
        submitBtn.disabled = false;
        return true;
    }

    dateDebut.addEventListener('change', validateDates);
    dateEcheance.addEventListener('change', validateDates);

    // Validation côté client avant soumission
    form.addEventListener('submit', function(e) {
        let isValid = true;

        // Validation des champs requis
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });

        // Validation des dates
        if (!validateDates()) {
            isValid = false;
        }

        // Validation de la longueur de la description
        if (descriptionField.value.length > 500) {
            descriptionField.classList.add('is-invalid');
            isValid = false;
        }

        if (!isValid) {
            e.preventDefault();
            // Scroll vers le premier champ invalide
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });

    // Supprimer la validation en temps réel
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                this.classList.remove('is-invalid');
            }
        });
    });

    // Formater automatiquement les dates si vides
    if (!dateDebut.value) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        dateDebut.value = now.toISOString().slice(0, 16);
    }

    if (!dateEcheance.value) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setMinutes(tomorrow.getMinutes() - tomorrow.getTimezoneOffset());
        dateEcheance.value = tomorrow.toISOString().slice(0, 16);
    }
});
</script>

<style>
.form-label {
    font-weight: 500;
    color: #495057;
}

.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.form-text {
    font-size: 0.875rem;
    color: #6c757d;
}

.alert {
    border-radius: 8px;
}

.btn {
    border-radius: 6px;
    padding: 8px 16px;
}
</style>
{% endblock %}
