{% extends "moderation/base.html" %}
{% block content %}
<div class="container py-5">

  <!-- PAGE HEADER -->
  <div class="mb-5 text-center">
    <h2 class="fw-bold mb-1">
      {% if report %}Modifier le signalement{% else %}Nouveau signalement{% endif %}
    </h2>
    <p class="text-muted fs-6">
      {% if report %}
        Modifiez les informations du signalement. Les tags IA sont générés automatiquement selon le score et la détection de plagiat ou contenu inapproprié.
      {% else %}
        Créez un nouveau signalement — les tags IA seront remplis automatiquement selon le score IA, le plagiat et la détection NSFW.
      {% endif %}
    </p>
  </div>

  <!-- FORM CARD -->
  <div class="card shadow-sm border-0 rounded-4">
    <div class="card-body">
      <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="row g-4">

          <!-- LEFT COLUMN -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-bold">Titre</label>
              <input type="text" name="{{ form.title.name }}" id="titleInput" value="{{ form.title.value }}" class="form-control form-control-sm">
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">URL de la ressource</label>
              <input type="text" name="{{ form.resource_url.name }}" id="urlInput" value="{{ form.resource_url.value }}" class="form-control form-control-sm">
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Signalé par</label>
              <input type="text" name="{{ form.flagged_by.name }}" id="flaggedByInput" value="{{ form.flagged_by.value }}" class="form-control form-control-sm">
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Score IA (0.0 – 1.0)</label>
              <input type="text" name="{{ form.ai_confidence.name }}" id="aiConfInput" value="{{ form.ai_confidence.value }}" class="form-control form-control-sm" readonly>
              <small class="text-muted">Les tags IA se mettront à jour automatiquement selon ce score, le plagiat ou la détection NSFW.</small>
            </div>
          </div>

          <!-- RIGHT COLUMN -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-bold">Description</label>
              <textarea name="{{ form.description.name }}" id="descInput" class="form-control form-control-sm" rows="5">{{ form.description.value }}</textarea>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Tags IA</label>
              <input type="text" name="{{ form.ai_flags.name }}" id="aiFlagsInput" value="{{ form.ai_flags.value }}" class="form-control form-control-sm bg-light" readonly>
            </div>

            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="nsfwCheck" disabled>
              <label class="form-check-label fw-bold" for="nsfwCheck">NSFW détecté</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="plagiarismCheck" disabled>
              <label class="form-check-label fw-bold" for="plagiarismCheck">Plagiat détecté</label>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-end gap-3 mt-4">
          <a href="{% url 'moderation:report_list' %}" class="btn btn-outline-secondary">Annuler</a>
          <button type="button" id="verifyAIButton" class="btn btn-info fw-bold">Vérifier AI</button>
          <button type="submit" class="btn btn-primary fw-bold">{% if report %}Mettre à jour{% else %}Créer{% endif %}</button>
        </div>

        <!-- Big AI Result Message -->
        <div id="aiResultMessage" class="mt-4 p-3 text-center fw-bold rounded" style="font-size:1.3rem;"></div>

      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const titleInput = document.getElementById('titleInput');
    const urlInput = document.getElementById('urlInput');
    const descInput = document.getElementById('descInput');
    const aiConfInput = document.getElementById('aiConfInput');
    const aiFlagsInput = document.getElementById('aiFlagsInput');
    const nsfwCheck = document.getElementById('nsfwCheck');
    const plagCheck = document.getElementById('plagiarismCheck');
    const aiResultMessage = document.getElementById('aiResultMessage');

    let debounceTimer;

    async function verifyAI() {
        const title = titleInput.value.trim();
        const url = urlInput.value.trim();
        const description = descInput.value.trim();
        if (!title) return;

        try {
            const response = await fetch("{% url 'moderation:verify_ai' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ title, url, description })
            });

            const data = await response.json();

            aiConfInput.value = data.ai_confidence.toFixed(2);
            aiFlagsInput.value = data.ai_flags.join(", ") || "Aucun tag détecté";
            nsfwCheck.checked = data.is_nsfw;
            plagCheck.checked = data.is_plagiarism;

            if(data.ai_confidence >= 0.65){
                aiResultMessage.textContent = "⚠️ Texte probablement écrit par une IA !";
                aiResultMessage.style.backgroundColor = "#f8d7da";
                aiResultMessage.style.color = "#721c24";
            } else if (data.ai_confidence >= 0.45){
                aiResultMessage.textContent = "⚠️ Texte incertain : pourrait être écrit par une IA ou un humain.";
                aiResultMessage.style.backgroundColor = "#fff3cd";
                aiResultMessage.style.color = "#856404";
            } else {
                aiResultMessage.textContent = "✅ Texte probablement écrit par un humain.";
                aiResultMessage.style.backgroundColor = "#d4edda";
                aiResultMessage.style.color = "#155724";
            }

        } catch (err) {
            console.error(err);
            alert("Erreur lors de la vérification AI");
        }
    }

    // Live detection as you type (debounced)
    descInput.addEventListener('keyup', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(verifyAI, 500);
    });

    // Manual verify button
    document.getElementById('verifyAIButton').addEventListener('click', verifyAI);
});
</script>
{% endblock %}
