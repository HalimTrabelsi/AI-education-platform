{% extends layout_path %}

{% block title %}{{ resource.title }}{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">{{ resource.title }}</h5>
          <small class="text-body-secondary text-uppercase">{{ resource.resource_type }}</small>
        </div>
        <div class="card-body">
          {% if file_url %}
            {% if resource.resource_type == 'IMAGE' %}
              <img src="{{ file_url }}" class="img-fluid rounded mb-4" alt="{{ resource.title }}">
            {% elif resource.resource_type == 'VIDEO' %}
              <video class="w-100 rounded mb-4" controls preload="metadata">
                <source src="{{ file_url }}" type="video/mp4">
              </video>
            {% elif resource.resource_type == 'PDF' %}
              <iframe src="{{ file_url }}" class="w-100" style="height:480px;" title="{{ resource.title }}"></iframe>
            {% else %}
              <a href="{{ file_url }}" class="btn btn-outline-primary">
                <i class="bx bx-link-external me-1"></i> Open resource
              </a>
            {% endif %}
          {% endif %}

          <div class="mt-4">
            <h6>Description</h6>
            {% if resource.description %}
              <p class="text-body-secondary">{{ resource.description }}</p>
            {% else %}
              <p class="text-body-secondary">No description provided.</p>
            {% endif %}
          </div>

          {% if tags %}
            <div class="mt-3">
              <h6>Associated tags</h6>
              {% for tag in tags %}
                <span class="badge bg-label-info me-1">{{ tag }}</span>
              {% endfor %}
            </div>
          {% endif %}

          {% if file_url %}
            <a href="{{ file_url }}" target="_blank" class="btn btn-primary mt-4">
              <i class="bx bx-file me-1"></i> Open course
            </a>
          {% endif %}
          {% if quiz_url %}
            <a href="{{ quiz_url }}" class="btn btn-outline-info mt-2">
              <i class="bx bx-question-mark"></i> Start quiz
            </a>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Automatic summary</h5>
          <form id="ai-summary-form" method="post" action="{% url 'resources:generate_summary' resource.id %}">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-primary" type="submit">
              <i class="bx bx-refresh me-1"></i> Generate summary
            </button>
          </form>
        </div>
        <div class="card-body" id="ai-summary-result">
          {% if resource.summary %}
            {% for paragraph in resource.summary.splitlines %}
              {% if paragraph %}
                <p>{{ paragraph }}</p>
              {% endif %}
            {% endfor %}
          {% else %}
            <p class="text-body-secondary">No summary available yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h6 class="mb-3">Informations</h6>
          <p class="text-body-secondary mb-2">Uploaded on {{ resource.uploaded_at|date:"d/m/Y H:i" }}</p>
          {% if resource.file %}
            <a href="{{ file_url }}" download class="btn btn-outline-success w-100">
              <i class="bx bx-download me-1"></i> Download
            </a>
          {% endif %}
          <a href="{% url 'resources:front' %}" class="btn btn-link d-block mt-3">
            <i class="bx bx-chevron-left"></i> Back to resources
          </a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block page_js %}
  {{ block.super }}
  <script>
    (function() {
      const form = document.getElementById('ai-summary-form');
      if (!form) return;

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const resultDiv = document.getElementById('ai-summary-result');
        resultDiv.innerHTML = '<p class="text-body-secondary">Summary generation in progress...</p>';

        fetch(form.action, {
          method: 'POST',
          body: new FormData(form),
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(res => res.json())
        .then(data => {
          const paragraphs = data.summary.split(/\\n+/);
          resultDiv.innerHTML = '';
          paragraphs.forEach(p => {
            if (p.trim()) {
              const para = document.createElement('p');
              para.textContent = p.trim();
              resultDiv.appendChild(para);
            }
          });
        })
        .catch(() => {
          resultDiv.innerHTML = '<p class="text-danger">An error occurred. Try again later.</p>';
        });
      });
    })();
  </script>
{% endblock %}

